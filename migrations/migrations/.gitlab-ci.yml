stages:
  - build
  - test
  - deploy

variables:
  GOOSE_DRIVER: postgres
  GOOSE_TABLE: public.goose_migrations
  GOOSE_MIGRATION_DIR: ./migrations

# Cache Go modules
cache:
  paths:
    - .cache/pip
    - .cache/go

build-goose:
  stage: build
  image: golang:1.24-alpine
  script:
    - echo "ğŸš€ [$(date '+%Y-%m-%d %H:%M:%S')] Starting Goose build process..."
    - echo "ğŸ“¦ Installing git..."
    - apk add --no-cache git ansible
    - echo "ğŸ”— Cloning Goose repository..."
    - git clone https://github.com/pressly/goose.git
    - echo "ğŸ“ Changing to goose directory..."
    - cd goose
    - echo "ğŸ”¨ Building Goose with PostgreSQL driver only..."
    - go build -tags='no_clickhouse no_libsql no_mssql no_mysql no_sqlite3 no_vertica no_ydb' -o goose ./cmd/goose
    - echo "âœ… Goose build completed successfully!"
    - cd ..
    - echo "ğŸ“‹ Moving build artifacts..."
    - mv goose goose-code
    - mv goose-code/goose ./goose
    - echo "ğŸ¯ [$(date '+%Y-%m-%d %H:%M:%S')] Goose build process completed!"
    - echo "ğŸ”‘ Decrypting .env file..."
    - echo $ANSIBLE_SECRET > /root/secret
    - ansible-vault decrypt .env --vault-password-file /root/secret 1>&2
    - echo "ğŸ”‘ .env file decrypted successfully!"
    - rm /root/secret
    - echo "ğŸ”‘ .env file removed successfully!"
  artifacts:
    paths:
      - ./goose
      - .env
    expire_in: 1 hour
  tags:
    - dev

# Test migrations against temporary PostgreSQL database
test-migrations:
  stage: test
  image: alpine:latest
  dependencies:
    - build-goose
  variables:
    POSTGRES_HOST: postgres
    POSTGRES_PORT: 5432
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    POSTGRES_DB: postgres
    GOOSE_DBSTRING: postgres://postgres:postgres@postgres:5432/postgres?sslmode=disable
  services:
    - postgres:15-alpine
  tags:
    - dev
  before_script:
    - echo "ğŸ”§ [$(date '+%Y-%m-%d %H:%M:%S')] Installing dependencies for migration testing..."
    - apk add --no-cache git postgresql-client
    - echo "âœ… Dependencies installed successfully!"
  script:
    # Wait for PostgreSQL to be ready
    - |
      echo "â³ [$(date '+%Y-%m-%d %H:%M:%S')] Waiting for PostgreSQL to be ready..."
      echo "ğŸ“ PostgreSQL Host: $POSTGRES_HOST"
      echo "ğŸ”Œ PostgreSQL Port: $POSTGRES_PORT"
      echo "ğŸ‘¤ PostgreSQL User: $POSTGRES_USER"
      echo "ğŸ—„ï¸  PostgreSQL Database: $POSTGRES_DB"

      until pg_isready -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER; do
        echo "â° [$(date '+%Y-%m-%d %H:%M:%S')] PostgreSQL is not ready yet. Waiting..."
        sleep 2
      done
      echo "âœ… [$(date '+%Y-%m-%d %H:%M:%S')] PostgreSQL is ready and accepting connections!"

    - echo "ğŸ“ [$(date '+%Y-%m-%d %H:%M:%S')] Listing migration folder contents:"
    - ls -la ./migrations

    - echo "ğŸ“Š [$(date '+%Y-%m-%d %H:%M:%S')] Current migration status:"
    - ./goose status || echo "âš ï¸  No migrations table found yet (this is normal for first run)"

    - echo "ğŸš€ [$(date '+%Y-%m-%d %H:%M:%S')] Starting migration test..."
    - |
      if ./goose up; then
        echo "âœ… [$(date '+%Y-%m-%d %H:%M:%S')] Migration test completed successfully!"
        echo "ğŸ“Š [$(date '+%Y-%m-%d %H:%M:%S')] Final migration status:"
        ./goose status
      else
        echo "âŒ [$(date '+%Y-%m-%d %H:%M:%S')] Migration test failed!"
        echo "ğŸ“Š [$(date '+%Y-%m-%d %H:%M:%S')] Migration status after failure:"
        ./goose status
        exit 1
      fi

# Apply migrations to remote database
deploy-migrations:
  stage: deploy
  image: alpine:latest
  tags:
    - dev
  dependencies:
    - build-goose
  before_script:
    - echo "ğŸ”§ [$(date '+%Y-%m-%d %H:%M:%S')] Installing dependencies for migration deployment..."
    - apk add --no-cache git postgresql-client
    - echo "ğŸ“„ Loading environment variables..."
    - source .env
    - echo "âœ… Environment loaded successfully!"
  script:
    # Check current migration status
    - echo "ğŸ“Š [$(date '+%Y-%m-%d %H:%M:%S')] Checking current migration status..."
    - |
      if ./goose status; then
        echo "âœ… Migration status retrieved successfully"
      else
        echo "âš ï¸  Could not retrieve migration status (may be first deployment)"
      fi

    # Apply migrations
    - echo "ğŸš€ [$(date '+%Y-%m-%d %H:%M:%S')] Starting migration deployment to remote database..."
    - echo "ğŸ”— Database connection configured"
    - |
      if ./goose up; then
        echo "âœ… [$(date '+%Y-%m-%d %H:%M:%S')] Migration deployment completed successfully!"
        echo "ğŸ“Š [$(date '+%Y-%m-%d %H:%M:%S')] Final migration status:"
        ./goose status
      else
        echo "âŒ [$(date '+%Y-%m-%d %H:%M:%S')] Migration deployment failed!"
        echo "ğŸ“Š [$(date '+%Y-%m-%d %H:%M:%S')] Migration status after failure:"
        ./goose status
        exit 1
      fi
  after_script:
    - echo "ğŸ [$(date '+%Y-%m-%d %H:%M:%S')] Migration deployment process completed!"
  only:
    - main
    - dev
  allow_failure: false

# Optional: Rollback job for emergency situations
rollback-migrations:
  stage: deploy
  image: alpine:latest
  tags:
    - dev
  before_script:
    - echo "ğŸ”§ [$(date '+%Y-%m-%d %H:%M:%S')] Installing dependencies for migration rollback..."
    - apk add --no-cache git postgresql-client
    - echo "ğŸ“„ Loading environment variables..."
    - source .env
    - echo "âœ… Environment loaded successfully!"
  script:
    - echo "ğŸ“Š [$(date '+%Y-%m-%d %H:%M:%S')] Current migration status before rollback:"
    - ./goose status

    - echo "âª [$(date '+%Y-%m-%d %H:%M:%S')] Starting migration rollback (rolling back 1 migration)..."
    - |
      if ./goose down 1; then
        echo "âœ… [$(date '+%Y-%m-%d %H:%M:%S')] Migration rollback completed successfully!"
      else
        echo "âŒ [$(date '+%Y-%m-%d %H:%M:%S')] Migration rollback failed!"
        exit 1
      fi

    # Verify status after rollback
    - echo "ğŸ“Š [$(date '+%Y-%m-%d %H:%M:%S')] Migration status after rollback:"
    - ./goose status
  after_script:
    - echo "ğŸ [$(date '+%Y-%m-%d %H:%M:%S')] Migration rollback process completed!"
  only:
    - main
    - dev
  when: manual
  allow_failure: false
